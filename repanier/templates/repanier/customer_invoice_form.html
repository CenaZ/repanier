{% extends 'subpage_base_wo_cms_toolbar.html' %}
{% load cms_tags sekizai_tags i18n l10n repanier_tags %}
{% block sub_content %}
{% addtoblock "css" %}
<style type="text/css">
body > .container {
  padding: 60px 15px 0;
}
</style>
{% endaddtoblock %}
    <div class="container">
        {# {% debug %} #}
        <div class="panel {% if object.balance < 0 %}panel-danger{% else %}panel-success{% endif %}">
            <div class="panel-heading">
                <small>{{ object.date_balance | date:"DATE_FORMAT" }}</small>
                <h4>{% trans "New balance" %} {{ object.customer.long_basket_name }}
                    : {{ object.balance }}&nbsp;&euro;</h4>
            </div>
        </div>
        {% if bank_account_set %}
            <h4>{% trans "Bank movement(s) :" %}</h4>
            <table class="table table-hover table-bordered">
                <thead>
                <tr>
                    <th>
                        {% trans "Date" %}
                    </th>
                    <th align="right">
                        {% trans "Payment" %}
                    </th>
                    <th align="right">
                        {% trans "Refund" %}
                    </th>
                    <th>
                        {% trans "Comment" %}
                    </th>
                <tr>
                </thead>
                <tbody>
                {% for bank_account in bank_account_set %}
                    <tr>
                        <td>
                            {{ bank_account.operation_date }}
                        </td>
                        <td align="right">
                            {{ bank_account.bank_amount_in }}&nbsp;&euro;
                        </td>
                        <td align="right">
                            {{ bank_account.bank_amount_out }}&nbsp;&euro;
                        </td>
                        <td>
                            {% if bank_account.operation_comment %}
                                {{ bank_account.operation_comment }}
                            {% endif %}
                        </td>
                    <tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <h4>{% trans "No bank movement found" %}</h4>
        {% endif %}
        {% if purchase_set %}
            <h4>{{ object.permanence }} - {% trans "Purchase(s) :" %} {{ object.total_price_with_tax }}&nbsp;&euro;</h4>
            {% if DISPLAY_VAT == True %}
                {% if object.total_vat != 0 or object.total_compensation != 0 or object.total_deposit != 0 %}
                    <h4>
                        <small>{% trans "This price include" %} <span class="glyphicon glyphicon-arrow-right"></span>
                            {% if object.total_vat != 0 %}{% trans "Vat" %} : {{ object.total_vat }}&nbsp;&euro;{% endif %}
                        </small>
                    </h4>
                    <h4>
                        <small>{% if object.total_compensation != 0 %}{% if object.total_vat != 0 %}
                            , {% endif %}{% trans "Compensation" %} : {{ object.total_compensation }}&nbsp;
                            &euro;{% endif %}</small>
                    </h4>
                    <h4>
                        <small>{% if object.total_deposit != 0 %}
                            {% if object.total_vat != 0 or object.total_compensation != 0 %}
                                , {% endif %}{% trans "Deposit" %} : {{ object.total_deposit }}&nbsp;
                            &euro;{% endif %}</small>
                    </h4>
                {% endif %}
            {% endif %}
            <table class="table table-hover table-bordered">
                <thead>
                <tr>
                    <th>
                    {% if DISPLAY_PRODUCERS_ON_ORDER_FORM == True %}
                        {% trans "Producer" %}
                    {% else %}
                        {% trans "Department" %}
                    {% endif %}
                    </th>
                    <th>
                        {% trans "Product" %}
                    </th>
                    <th>
                        {% trans "Qty" %}
                    </th>
                    <th>
                        {% trans "Unit price" %}
                    </th>
                    <th>
                        {% trans "Total price" %}
                    </th>
                    <th>
                        {% trans "Comment" %}
                    </th>
                <tr>
                </thead>
                <tbody>
                {% for purchase in purchase_set %}
                    <tr>
                        <td>
                        {%  if DISPLAY_PRODUCERS_ON_ORDER_FORM == True %}
                            {{ purchase.offer_item.producer.short_profile_name | truncatechars:15 }}
                        {% else %}
                            {{ purchase.offer_item.department_for_customer.short_name | truncatechars:15 }}
                        {% endif %}
                        </td>
                        <td>
                            {{ purchase.offer_item.get_long_name }}
                        </td>
                        <td align="right">
                            {{ purchase.quantity_invoiced | floatformat:3 }}
                        </td>
                        <td align="right">
                            {{ purchase.get_customer_unit_price }}&nbsp;&euro;{% if purchase.offer_item.unit_deposit %}
                            <span class="glyphicon glyphicon-plus"></span> {{ purchase.offer_item.unit_deposit }}&nbsp;&euro;
                            <span class="glyphicon glyphicon-leaf"></span>{% endif %}
                        </td>
                        <td align="right">
                            {{ purchase.selling_price }}&nbsp;&euro;
                        </td>
                        <td>
                            {{ purchase.comment|default:"" }}
                        </td>
                    <tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <h4>{% trans "No purchase found" %}</h4>
        {% endif %}
        <h4>{% trans "Previous balance" %} : {{ object.previous_balance }}&nbsp;&euro;
            <small>({{ object.date_previous_balance | date:"DATE_FORMAT" }})</small>
        </h4>
    </div>
{% addtoblock "lastjs" %}
    <script type="text/javascript">
        $(document).ready(function () {
            lien = '{% url 'order_name' %}';
            $.ajax({
                url: lien,
                cache: false,
                async: false,
                success: function (result) {
                    $("#my_name").html(result);
                    if(result == '{% trans "Anonymous" %}') {
                        $("#connected").show();
                        $("#not_connected").hide();
                    }
                },
                error: function (result) {
                    $("#my_name").html("{% trans "Retry5" %}");
                }
            });
            lien = '{% url 'my_balance' %}';
            $.ajax({
                url: lien,
                cache: false,
                async: false,
                success: function (result) {
                    $("#my_balance").html(result);
                },
                error: function (result) {
                    $("#my_balance").html("{% trans "Retry7" %}");
                }
            });
        });
    </script>
{% endaddtoblock %}
{% endblock %}
{% block footer %}
    <div class="hidden-xs">
        <br/>
    </div>
    <div class="btn-group">
        {% if previous_customer_invoice_id %}
            <a href="{% url 'customer_invoice_view' previous_customer_invoice_id %}" class="btn btn-success btn-disabled">&nbsp;&nbsp;&nbsp;&nbsp;<span
                    class="glyphicon glyphicon-arrow-left"></span>&nbsp;&nbsp;&nbsp;&nbsp;</a>
        {% else %}
            <a href="#" class="btn btn-disabled"></a>
        {% endif %}
        {% if previous_customer_invoice_id or next_customer_invoice_id %}
            <a href="#" class="btn btn-disabled"> {% trans "Invoice" %} </a>
        {% endif %}
        {% if next_customer_invoice_id %}
            <a href="{% url 'customer_invoice_view' next_customer_invoice_id %}"
               class="btn btn-success btn-disabled">&nbsp;&nbsp;&nbsp;&nbsp;<span class="glyphicon glyphicon-arrow-right"></span>&nbsp;&nbsp;&nbsp;&nbsp;</a>
        {% else %}
            <a href="#" class="btn btn-disabled"></a>
        {% endif %}
    </div>
    <div class="hidden-xs">
        <br/>
    </div>
{% endblock %}